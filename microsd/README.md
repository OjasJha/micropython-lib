# SD Card Driver for MicroPython

MIT License

Copyright (c) 2025 Ojas Jha

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

## Overview

This module provides a complete SD card interface for the Raspberry Pi Pico using SPI (Serial Peripheral Interface) communication. It enables reading from and writing to SD cards, allowing them to be mounted as a FAT filesystem for data storage, logging applications, and embedded data recording.

### Key Features

- **Full SD Card Support**: Works with SDSC (≤2GB), SDHC (2-32GB), and SDXC (32GB-2TB) cards
- **SPI Communication**: Hardware SPI implementation for reliable data transfer
- **Filesystem Integration**: Compatible with MicroPython's VFS (Virtual File System)
- **Block Device Interface**: Standard 512-byte sector operations
- **Comprehensive Error Handling**: Robust detection and recovery mechanisms
- **Educational Documentation**: Extensively commented code for learning
- **Production Ready**: Tested and validated on Raspberry Pi Pico 2 W

### What This Module Does

1. **Hardware Communication**: Interfaces with SD cards via SPI protocol
2. **Card Initialization**: Automatic detection and configuration of different SD card types
3. **Block-Level Operations**: Read and write 512-byte data blocks
4. **Filesystem Mounting**: Enables standard file operations (open, read, write, delete)
5. **Data Logging**: Perfect for sensor data collection and event logging

---

## Hardware Requirements

### Components Needed

- **Raspberry Pi Pico / Pico W / Pico 2 W**
- **SD Card Module** (with SPI interface)
  - Examples: Standard SD card breakout board, microSD card module
- **SD Card** (formatted as FAT16 or FAT32)
  - Recommended: 2GB-32GB, FAT32 formatted
- **Jumper Wires** (6 connections needed)

### Hardware Connections

Connect your SD card module to the Raspberry Pi Pico as follows:

```
SD Card Module          Raspberry Pi Pico
──────────────          ─────────────────
CS  (Chip Select)   →   GPIO 13 (Pin 17)
SCK (Serial Clock)  →   GPIO 10 (Pin 14) - SPI1 SCK
MOSI (Master Out)   →   GPIO 11 (Pin 15) - SPI1 TX
MISO (Master In)    →   GPIO 12 (Pin 16) - SPI1 RX
VCC                 →   3.3V (Pin 36)    ⚠️ NOT 5V!
GND                 →   GND (Pin 38)
```

### Pin Explanation

- **CS (Chip Select)**: Active-low signal to select the SD card (can be any GPIO)
- **SCK (Serial Clock)**: Clock signal generated by Pico to synchronize data transfer
- **MOSI (Master Out Slave In)**: Data line from Pico to SD card
- **MISO (Master In Slave Out)**: Data line from SD card to Pico
- **VCC**: Power supply - **IMPORTANT**: Use 3.3V, NOT 5V!
- **GND**: Common ground reference

### Alternative Pin Configurations

You can use different GPIO pins, but ensure they match the SPI controller you select:

**SPI0 Option:**
```python
spi = machine.SPI(0,
                  sck=machine.Pin(2),   # SPI0 SCK
                  mosi=machine.Pin(3),  # SPI0 TX
                  miso=machine.Pin(4))  # SPI0 RX
cs = machine.Pin(1)
```

**SPI1 Option (Default):**
```python
spi = machine.SPI(1,
                  sck=machine.Pin(10),   # SPI1 SCK
                  mosi=machine.Pin(11),  # SPI1 TX
                  miso=machine.Pin(12))  # SPI1 RX
cs = machine.Pin(13)
```

---

## File Descriptions

### `sdcard_handler.py`

The main SD card driver module that implements the SD card protocol and block device interface.

**Key Components:**
- `SDCard` class: Main driver class with complete SD card functionality
- SPI initialization and configuration
- SD card command protocol (CMD0, CMD8, CMD17, CMD18, CMD24, CMD25, etc.)
- Block read/write operations
- Filesystem integration (readblocks, writeblocks, ioctl)

**Features:**
- Automatic card type detection (v1.x vs v2.x)
- Support for byte addressing (SDSC) and block addressing (SDHC/SDXC)
- Single and multiple block operations
- CRC validation for reliable data transfer
- Comprehensive error handling and timeout management

### `sdcard-test.py`

Comprehensive test suite that validates SD card functionality and demonstrates usage patterns.

**Test Coverage:**
- Hardware initialization and card detection
- Filesystem mounting and unmounting
- File creation and writing operations
- Data reading and verification
- Timestamped data logging simulation
- Error handling and troubleshooting guidance

**Use Cases:**
- Validate hardware connections
- Test SD card compatibility
- Learn SD card programming concepts
- Debug communication issues
- Benchmark read/write performance

---

## Installation & Setup

### Step 1: Prepare the SD Card

1. **Format the SD card** using FAT32 filesystem
   - For Windows: Right-click → Format → FAT32
   - For macOS: Disk Utility → Erase → MS-DOS (FAT)
   - For Linux: `sudo mkfs.vfat -F 32 /dev/sdX1`

2. **Verify the card** is properly formatted and readable

### Step 2: Upload Files to Pico

1. Connect your Raspberry Pi Pico to your computer
2. Copy `sdcard_handler.py` to the Pico's filesystem
   - Use Thonny IDE, rshell, or ampy
3. Optionally copy `sdcard-test.py` for testing

```bash
# Using ampy (if installed)
ampy --port COM3 put sdcard_handler.py
ampy --port COM3 put sdcard-test.py
```

### Step 3: Wire the Hardware

Connect the SD card module to your Pico according to the wiring diagram above.

**Important Notes:**
- Ensure all connections are secure
- Double-check power connections (3.3V, NOT 5V!)
- Some SD card modules have built-in level shifters
- Use short wires (< 20cm) for reliable SPI communication

### Step 4: Run the Test

```python
# In Thonny or MicroPython REPL
import sdcard-test
# The test will automatically run and display results
```

---

## Usage Examples

### Basic Usage - Mount and Use SD Card

```python
import machine
import sdcard_handler
import uos

# Initialize SPI interface
spi = machine.SPI(1,
                  baudrate=1000000,
                  polarity=0,
                  phase=0,
                  bits=8,
                  firstbit=machine.SPI.MSB,
                  sck=machine.Pin(10),
                  mosi=machine.Pin(11),
                  miso=machine.Pin(12))

# Initialize chip select pin
cs = machine.Pin(13, machine.Pin.OUT)

# Create SD card object
sd = sdcard_handler.SDCard(spi, cs)

# Mount the SD card
vfs = uos.VfsFat(sd)
uos.mount(vfs, '/sd')

# Now you can use standard file operations!
with open('/sd/test.txt', 'w') as f:
    f.write('Hello, SD Card!')

with open('/sd/test.txt', 'r') as f:
    print(f.read())  # Output: Hello, SD Card!

# List files on SD card
print(uos.listdir('/sd'))

# Unmount when done (optional but recommended)
uos.umount('/sd')
```

### Data Logging Example

```python
import machine
import sdcard_handler
import uos
import time

# Initialize SD card (same as above)
spi = machine.SPI(1, baudrate=1000000,
                  sck=machine.Pin(10),
                  mosi=machine.Pin(11),
                  miso=machine.Pin(12))
cs = machine.Pin(13, machine.Pin.OUT)
sd = sdcard_handler.SDCard(spi, cs)

# Mount filesystem
uos.mount(uos.VfsFat(sd), '/sd')

# Create timestamped log file
timestamp = time.time()
log_file = f'/sd/sensor_log_{timestamp}.txt'

# Log sensor data
with open(log_file, 'w') as f:
    f.write('Timestamp,Temperature,Humidity\n')
    
    for ii in range(100):
        # Simulate sensor readings
        temp = 20 + ii * 0.1
        humidity = 50 + ii * 0.05
        
        # Write to file
        f.write(f'{time.time()},{temp:.2f},{humidity:.2f}\n')
        
        time.sleep(1)  # Wait 1 second between readings

print(f'Data logged to {log_file}')
```

### Read/Write Binary Data

```python
import machine
import sdcard_handler
import uos

# Initialize and mount SD card (as shown above)
spi = machine.SPI(1, baudrate=1000000,
                  sck=machine.Pin(10),
                  mosi=machine.Pin(11),
                  miso=machine.Pin(12))
cs = machine.Pin(13, machine.Pin.OUT)
sd = sdcard_handler.SDCard(spi, cs)
uos.mount(uos.VfsFat(sd), '/sd')

# Write binary data
data = bytearray([0x01, 0x02, 0x03, 0x04, 0x05])
with open('/sd/binary.dat', 'wb') as f:
    f.write(data)

# Read binary data
with open('/sd/binary.dat', 'rb') as f:
    read_data = f.read()
    print(read_data)  # Output: bytearray(b'\x01\x02\x03\x04\x05')
```

### Working with Directories

```python
import uos

# Create directory
uos.mkdir('/sd/data')

# Create subdirectories
uos.mkdir('/sd/data/logs')
uos.mkdir('/sd/data/config')

# Write to subdirectory
with open('/sd/data/logs/system.log', 'w') as f:
    f.write('System started\n')

# List directory contents
print(uos.listdir('/sd/data'))  # Output: ['logs', 'config']

# Remove files/directories
uos.remove('/sd/data/logs/system.log')
uos.rmdir('/sd/data/logs')
```

---

## SD Card Compatibility

### Supported Card Types

| Type | Capacity | Addressing | Filesystem |
|------|----------|------------|------------|
| SDSC | Up to 2GB | Byte | FAT16 |
| SDHC | 2GB - 32GB | Block | FAT32 |
| SDXC | 32GB - 2TB | Block | FAT32/exFAT |

**Recommended**: Use SDHC cards (4GB-32GB) with FAT32 for best compatibility.

### Filesystem Support

- ✅ **FAT16**: Supported (cards ≤2GB)
- ✅ **FAT32**: Supported (recommended, 2GB-32GB)
- ⚠️ **exFAT**: Limited support (not recommended)
- ❌ **NTFS**: Not supported

---

## Troubleshooting

### Problem: "No SD card detected"

**Possible Causes:**
1. SD card not inserted properly
2. Incorrect wiring connections
3. Using 5V instead of 3.3V
4. Loose connections

**Solutions:**
- Double-check all wiring connections
- Ensure SD card is fully inserted
- Verify 3.3V power supply (NOT 5V)
- Try a different SD card
- Check continuity of jumper wires

### Problem: "OSError: No response from SD card"

**Possible Causes:**
1. SPI pins incorrectly configured
2. Wrong SPI controller selected
3. Incompatible SD card
4. Damaged SD card

**Solutions:**
- Verify SPI pin assignments match your wiring
- Try lower baudrate (400000 Hz) for initialization
- Test with a different SD card
- Check if card works in a computer

### Problem: "Cannot mount filesystem"

**Possible Causes:**
1. SD card not formatted correctly
2. Corrupted filesystem
3. Wrong filesystem type

**Solutions:**
- Format SD card as FAT32 using a computer
- Use SD Card Formatter tool (recommended)
- Try a freshly formatted card
- Check card in computer first

### Problem: "File operations fail randomly"

**Possible Causes:**
1. Unreliable connections (loose wires)
2. SPI baudrate too high
3. Power supply issues
4. Electrical noise

**Solutions:**
- Use shorter jumper wires (< 20cm)
- Reduce SPI baudrate to 1MHz or lower
- Add 10-22μF capacitor across VCC and GND
- Ensure stable 3.3V power supply
- Keep wires away from motors/relays

### Problem: "Card initializes but writes fail"

**Possible Causes:**
1. SD card is write-protected
2. Card is full (no space)
3. Filesystem corruption

**Solutions:**
- Check physical write-protect switch on SD card
- Verify free space using computer
- Reformat SD card
- Try different SD card

---

## Performance Considerations

### SPI Speed Settings

- **Initialization**: 100-400 kHz (slow but reliable)
- **Normal Operation**: 1-25 MHz (depends on card and wiring)
- **Recommended**: 1-5 MHz for stable operation

```python
# Conservative (most reliable)
sd = sdcard_handler.SDCard(spi, cs, spi_baudrate=1000000)  # 1 MHz

# Balanced (good performance)
sd = sdcard_handler.SDCard(spi, cs, spi_baudrate=5000000)  # 5 MHz

# Fast (requires good connections)
sd = sdcard_handler.SDCard(spi, cs, spi_baudrate=10000000)  # 10 MHz
```

### Write Performance Tips

1. **Buffer writes**: Collect data before writing to reduce file operations
2. **Use larger writes**: Write multiple records at once
3. **Avoid frequent mounts**: Keep filesystem mounted during logging
4. **Flush periodically**: Use `f.flush()` to ensure data is written
5. **Close files properly**: Always close files or use context managers

### Memory Considerations

- Each SD card instance uses ~1KB for buffers
- Frame buffer is 512 bytes for block operations
- Avoid creating multiple SD card instances
- Close unused files to free memory
- Use `gc.collect()` periodically for long-running applications

---

## Technical Details

### SD Card Initialization Sequence

1. Power up with slow SPI clock (≤400kHz)
2. Send 74+ clock cycles with CS high (wake up card)
3. Send CMD0 to reset and enter SPI mode
4. Send CMD8 to check voltage and card version
5. Initialize based on card type (ACMD41)
6. Read Card Specific Data (CSD) for capacity
7. Set block size to 512 bytes (CMD16)
8. Switch to high-speed SPI (1-25MHz)

### Block Device Interface

The driver implements MicroPython's block device protocol:

- `readblocks(block_num, buf)`: Read one or more 512-byte blocks
- `writeblocks(block_num, buf)`: Write one or more 512-byte blocks
- `ioctl(op, arg)`: Control operations (get size, block count)

### SPI Communication Protocol

**Command Format (6 bytes):**
```
[0x40 | CMD] [ARG3] [ARG2] [ARG1] [ARG0] [CRC]
```

**Response Format:**
- R1: 1 byte (most common)
- R3/R7: 5 bytes (includes additional data)
- Data Block: Start token + 512 bytes + 2 byte CRC

---

## Educational Resources

### Understanding SPI Communication

SPI (Serial Peripheral Interface) is a synchronous serial communication protocol:

- **Full-Duplex**: Data can be sent and received simultaneously
- **Master-Slave**: Pico is master, SD card is slave
- **Four-Wire**: MOSI, MISO, SCK, CS
- **Clock-Synchronized**: Data transfer synchronized by SCK

### SD Card Command Reference

Common SD commands used in this driver:

- **CMD0**: Reset card to idle state (GO_IDLE_STATE)
- **CMD8**: Check voltage compatibility (SEND_IF_COND)
- **CMD9**: Read Card Specific Data (SEND_CSD)
- **CMD16**: Set block length (SET_BLOCKLEN)
- **CMD17**: Read single block (READ_SINGLE_BLOCK)
- **CMD18**: Read multiple blocks (READ_MULTIPLE_BLOCK)
- **CMD24**: Write single block (WRITE_BLOCK)
- **CMD25**: Write multiple blocks (WRITE_MULTIPLE_BLOCK)
- **CMD55**: Application specific command follows (APP_CMD)
- **ACMD41**: Send operating condition (SD_SEND_OP_COND)

### Further Reading

- [SD Card Physical Specification](https://www.sdcard.org/downloads/pls/)
- [MicroPython VFS Documentation](https://docs.micropython.org/en/latest/library/uos.html)
- [Raspberry Pi Pico Datasheet](https://datasheets.raspberrypi.com/pico/pico-datasheet.pdf)
- [SPI Protocol Tutorial](https://www.analog.com/en/analog-dialogue/articles/introduction-to-spi-interface.html)

---

## Examples and Tutorials

### Complete Data Logger Example

See `sdcard-test.py` for a complete working example that demonstrates:
- Hardware initialization
- Filesystem mounting
- Timestamped data logging
- File reading and verification
- Error handling
- Progress indication with LED

### Advanced Usage Patterns

For more advanced examples, see:
- Multiple file handling
- Binary data logging
- Configuration file storage
- Image/photo storage (with camera module)
- CSV data export
- Circular buffer logging

---

## Credits and Acknowledgments

This SD card driver is based on the official MicroPython SD card driver:
- Original Source: https://github.com/micropython/micropython/tree/master/drivers/sdcard
- Enhanced with extensive documentation and Raspberry Pi Pico specific examples

### References

- [MicroPython SD Card Module](https://docs.micropython.org/en/latest/library/machine.SDCard.html)
- [How2Electronics SD Card Tutorial](https://how2electronics.com/micro-sd-card-module-with-raspberry-pi-pico-micropython/)
- [Instructables Pico SD Interface](https://www.instructables.com/Raspberry-Pi-Pico-Micro-SD-Card-Interface/)
- [Data Logger Tutorial](https://how2electronics.com/data-logger-with-sd-card-raspberry-pi-pico-micropython/)

---

## License

MIT License - See license text at the top of this file.

**Author**: Ojas Jha  
**Date**: October 19, 2025  
**Version**: 1.0

---

## Contributing

This module is part of an educational MicroPython library collection. Contributions, bug reports, and suggestions are welcome!

---

## Version History

### Version 1.0 (October 19, 2025)
- Initial release with comprehensive documentation
- Full SD card protocol implementation
- Support for SDSC, SDHC, and SDXC cards
- Complete test suite
- Educational documentation and examples

---

## Support

For issues, questions, or suggestions:
1. Check the troubleshooting section above
2. Review the example code in `sdcard-test.py`
3. Verify hardware connections
4. Test with a known-good SD card

Happy coding with SD cards on your Raspberry Pi Pico! 🎉

